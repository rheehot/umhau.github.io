---
layout: post
title: Building a Statistical Language Model
date: '2016-10-11T23:10:00.002-04:00'
author: umhau
tags:
- Linux
- speech to text
- success
- Mint 17.3
- perl
- SRILM
- MITLM
- Language Model
- package installation
- CMU Sphinx
categories: walkthroughs
modified_time: '2016-11-23T14:50:58.170-05:00'
blogger_id: tag:blogger.com,1999:blog-2584289275272726799.post-220565936624200327
blogger_orig_url: http://nixingaround.blogspot.com/2016/10/building-statistical-language-model_11.html
---

<b>Update: </b>I finished my script for creating custom language models. &nbsp;See here:&nbsp;<a href="https://github.com/umhau/vmc">https://github.com/umhau/vmc</a>.<br /><br />There's a summary at the end with what I figured out. &nbsp;Most of this is me thinking on paper.<br /><br />The statistical language model is used for helping CMU Sphinx know what words exist, and what the order the words exist in (the grammar and syntax structure). &nbsp;The intro website to all this is here.<br /><br />I'm trying to decide between the SRILM and the MITLM packages [subsequent edit: also the logios package and the quicklm pearl script - these are referenced in hard-to-find places on the CMU website; see here and here, respectively] [another subsequent edit: looks like I found a link to the official CMU Statistical Language Model toolkit - it was buried in the QuickLM script]. &nbsp;S- is easier to use, apparently, and the CMU site provides example commands. &nbsp;M-, however, seems more likely to stick around and be accessible on github for the long-term. &nbsp;Plus, I forked it. <br /><br />[sorry, blogger's formatting broke and I had to convert everything to plaintext and start over...lost the links.]<br /><br />Only downside is, the main contributor to MITLM stopped work on it about 6 mos ago, and started dealing with Kaldi instead. &nbsp;Guess he figured the newer tech was more worth his time. &nbsp;Still, dinosaurs have their place; just watch Space Cowboys to get the picture. <br /><h3>MITLM</h3>Just to be sure that the software doesn't go anywhere, code is downloaded from my repository.<br /><br /><b>Update:</b>&nbsp;Thanks to Qi Wang's comment below there's an extra dependency to install:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">sudo apt-get install autoconf-archive</span></pre>Installation of MITLM:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">cd ~/tools<br />git clone https://github.com/umhau/mitlm.git<br />cd ./mitlm<br />./autogen.sh<br />./configure<br />make<br />make install</span></pre><strike>So, turns out that there's some weird problems with the installation. &nbsp;Something changed, or something isn't being installed properly. &nbsp;The compilation seems to fail with these errors:</strike><br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;"><strike>./configure: line 19641: AX_CXX_HEADER_TR1_UNORDERED_MAP: command not found<br />./configure: line 19642: syntax error near unexpected token `noext,'<br />./configure: line 19642: `AX_CXX_COMPILE_STDCXX_11(noext, optional)'</strike></span></pre><strike>g++ wasn't installed, but even after that was added it still wouldn't work.</strike><br /><br /><b>Update:</b>&nbsp;Unfortunately, I've lost track of other dependencies involved - at some point, I'll make a list of all the stuff I've installed while working on this project. &nbsp;Had to install libtool (or similar?) to get here. &nbsp;Mental note:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">libtoolize:   error: Failed to create 'build-aux'</span></pre>But, that's because I'm trying to do this on a different Mint installation from my usual - on my default workstation, that dependency is installed (no idea what it is, except that it's probably listed somewhere on this blog). <br /><div><br /></div><b>A</b>fter installing the extra dependency, the installation works! So this is a viable avenue thus far to get the LM working. &nbsp;I've already made it past where I need the MITLM, though, so I'm going to let it be for now. &nbsp;Might have to come back for it.<br /><h3>SRILM</h3>Ok, let's see what SRILM has to offer us. It's more inconvenient to install; ya have to go through a license agreement to download it, so I can't just stick a bash command here.<br /><br />...unless I put the code on my github. &nbsp;In which case, it's easy to get a copy of. &nbsp;Too bad there's too many files to put up an extracted version, and too bad the compressed version is more than 25mb. &nbsp;Time to split up the tar.gz file again; for my own records, here's how I split it. &nbsp;All I need for getting and using it is the reconstruction bit. <br /><br />The splitting part, given the archive file:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">split -b 24m -d srilm-1.7.1.tar.gz srilm-1.7.1.tar.gz.part-</span></pre>Alright. Once the file is on github, it's just more copy-pasting. <br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">cd ~/tools<br />git clone https://github.com/umhau/srilm.git<br />cd ./srilm<br />cat srilm-1.7.1.tar.gz.part-* | tar -xz</span></pre>By the way, WOW. &nbsp;The installation process for this software is not straightforward. &nbsp;See the install file for the instructions on installation - read for background, then copy-paste below as usual. <br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">gedit ./INSTALL</span></pre>Step 2 - swap out the SRILM variable for one delimiting the root directory of the package. <a href="http://sed%20-i%20%2737s/#//' ./src/Makefile" target="_blank">Source</a>.<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">sed -i '7s#.*#SRILM = ~/tools/srilm#' ./Makefile</span></span></pre>For now, assuming that the variables are all good. &nbsp;I don't know if I want maximum entropy models, though it sounds useful...I'll see what happens if I don't prep them. <br /><br />Installing John Ousterhout's TCL toolkit - we're past the required v7.3, and up to 8.6: hope this still works. &nbsp;I'm compiling from source rather than using the available binaries 'cause they come with some kind of non-commercial/education license, which I don't like being tied down by. <br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">cd ~/tools<br />git clone https://github.com/umhau/tcl-tk.git<br />cd ./tcl-tk<br />gunzip &lt; tcl8.6.6-src.tar.gz | tar xvf -<br />gunzip &lt; tk8.6.6-src.tar.gz | tar xvf -</span></pre>Install TCL:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">cd tcl8.6.6/unix<br /># chmod +x configure<br />configure --enable-threads<br />make -j 3<br />make test <br />sudo make -j 3 install</span></pre>Let's try running the rest without the TK stuff...even though John says it's needed. &nbsp;Heh. &nbsp;Leeeroooy Jenkins!<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">cd ../../../srilm<br />make World</span></pre>...aaaaaaaand, Fail. <br /><br />This is going nowhere fast. &nbsp;We're in dependency hell. &nbsp;Let's try the perl script CMU uses (it's the backend to the online service they officially reference). <br /><h3>The Perl Script</h3>Thankfully, Mint comes with perl installed. &nbsp;So, the question is how to use the script. <br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">cd ~/tools<br />mkdir ./CMU_LMtool &amp;&amp; cd ./CMU_LMtool<br />wget http://www.speech.cs.cmu.edu/tools/download/quick_lm.pl</span></pre>The only thing left here is to figure out how to use the script...having never used perl, this could be interesting. &nbsp;Dug this nugget out of the script:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">usage: quick_lm -s &lt;sentence_file&gt; [-w &lt;word_file&gt;] [-d discount]</span></pre>So, the idea with the LMtool is to process sentences that the decoder should recognize - it doesn't need to be an exhaustive list, however, because the decoder will allow fragments to recombine in the detection phase. &nbsp;As a corpus example (from the CMU website), here's the following:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">THIS IS AN EXAMPLE SENTENCE<br />EACH LINE IS SOMETHING THAT YOU'D WANT YOUR SYSTEM TO RECOGNIZE<br />ACRONYMS PRONOUNCED AS LETTERS ARE BEST ENTERED AS A T_L_A<br />NUMBERS AND ABBREVIATIONS OUGHT TO BE SPELLED OUT FOR EXAMPLE<br />TWO HUNDRED SIXTY THREE ET CETERA<br />YOU CAN UPLOAD A FEW THOUSAND SENTENCES<br />BUT THERE IS A LIMIT</span></pre>We'll use this sentence collection to test the perl script: <br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">cd ~/tools/CMU_LMtool<br />wget https://raw.githubusercontent.com/umhau/misc-LMtools/master/ex-corpus.txt<br />perl </span>quick_lm.pl -s ex-corpus.txt</pre>Well, it did exactly nothing. &nbsp;No terminal output, no new files created in the directory, and no errors. &nbsp;Time to search the script for other possible output locations. &nbsp;How weird can it be?<br /><br />...<br /><br />Ok, solved the problem. &nbsp;Thank goodness for auto highlighting in Gedit. &nbsp;The authors used some kind of weird system for comments that I'm guessing was retired since this script was written. &nbsp;It seems to have been throwing the compiler for a loop:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">=POD<br />/*<br />[some text wrapped by those comment markers]<br />*/<br />[more text, only wrapped by the '=' things]<br />=END</span></pre>So, I re-commented all the introductory stuff, and put the fixed version in the github repo.<br /><h4>Summary of the Perl script</h4>So, here's how it works: download the fixed script, give it a sentence list, and run the command. &nbsp;Simple. &nbsp;And, looking at the output, the function it performs is pretty simple too. &nbsp;Makes a list of all the 1, 2 and 3 - word groupings in the list. <br /><br />Here's what to do:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="line-height: 19.6px;">mkdir ~/tools/CMU_LMtool &amp;&amp; cd ~/tools/CMU_LMtool<br />wget https://raw.githubusercontent.com/umhau/misc-LMtools/master/ex-corpus.txt<br />wget https://raw.githubusercontent.com/umhau/misc-LMtools/master/quick_lm.pl<br />perl quick_lm.pl -s ex-corpus.txt</span></pre>Still not sure what that does for me, but I have my LM!<br /><br />Notes: I think the word list option in the command refers to the possibility of a limited vocabulary...not sure how that relates to words outside that list used in the sentence list. &nbsp;The discount in the command, however, is fixed at 0.5. &nbsp;Apparently Greg and Ben did some experiments to discover that's definitely the optimal setting. <br /><br />Second Note: &nbsp;based on readings from the CMU website, this LM isn't good for much more than command-and-control - it can successfully detect short phrases accurately, but not long, drawn-out sentences. &nbsp;So it'll be good for most of what I want, but anything complex will need to be done with the <a href="http://cmusphinx.sourceforge.net/wiki/tutoriallm#arpa_model_training_with_cmuclmtk" target="_blank">CMULMTK package</a>. <br /><br />Hold on - the&nbsp;<span style="background-color: #eff0f1; color: #333333; font-size: 14px; text-align: justify;">[-w &lt;word_file&gt;]</span>&nbsp;option for a dictionary might be a request for <i>output</i>&nbsp;- not an extra input. &nbsp;And given that I do need an explicit dictionary for transcription, that's probably what it does. &nbsp;That would be wonderful. &nbsp;I can even use that sentence list for voice training - which would be a fabulous way to ensure accuracy. <br /><br />Unfortunately, that's not the case. &nbsp;Oh, well.<br /><h3>The official CMU Statistical Language Model toolkit</h3>Ok, maybe this'll do it for me. &nbsp;<a href="http://www.speech.cs.cmu.edu/SLM_info.html" target="_blank">Here's the link</a> to the source. &nbsp;The Perl script doesn't make all the different files I need - especially the pronunciation dictionary. <br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">mkdir ./tools/CMUSLM<br />cd ./tools/CMUSLM<br />wget http://www.speech.cs.cmu.edu/SLM/CMU-Cam_Toolkit_v2.tar.gz<br />gunzip &lt; CMU-Cam_Toolkit_v2.tar.gz | tar xv<br />cd ./CMU-Cam_Toolkit_v2</span></span></pre>Wow, this is old. &nbsp;You have to uncomment something if your computer <i>isn't</i> running HP-UX, IRIX, SunOS, or Solaris. &nbsp;I'm pretty sure anything build in this decade needs uncomment, but if you're unsure the README mentions a script you can run to check for yourself:<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">bash endian.sh</span></span></pre>Ok, uncomment:<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">sed -i '37s/#//' ./src/Makefile<br />cd src<br />make install</span></span></pre>Hard to tell if this was successful. &nbsp;I get the impression watching this compile that it was written in the 80s, and updated for compatibility with something advertising a max capacity of 512 Mb of random access memory. <br /><br />Time to dive into the <a href="http://www.speech.cs.cmu.edu/SLM/toolkit_documentation.html" target="_blank">html documentation</a>, and figure out usage. &nbsp;The goal is to create the LM and DIC files - and a nice perk would be the other stuff produced by the online LM generator.<br /><br />Turns out, there doesn't seem to be any kind of pronunciation dictionary produced by this tool. &nbsp;So it's no good. <br /><h3>The Logios Package</h3>This seems to be the tool CMU claims was actually used in their website - and, indeed, some of their tools within the package are designed for use in a webform. &nbsp;So I might be on the right track. &nbsp;The only problem is, the input is not a list of sentences: it's a grammar file built by the Phoenix tool. No idea what that is or how it works. <br /><br />CMU, get your act together! &nbsp;The website is nice, but I've got no recourse if it goes down. &nbsp;I want an independent system!<br /><br />Here goes. &nbsp;Goal: LM and DIC files. &nbsp;Starting point: list of sentences.<br /><br />Download the package. &nbsp;Even this isn't user-friendly - the folder structure is in html. &nbsp;I used wget recursively to download the webpages. &nbsp;See <a href="http://stackoverflow.com/questions/13533217/how-to-download-all-links-to-zip-files-on-a-given-web-page-using-wget-curl#13574050" target="_blank">here</a> for source on the command.<br /><h3>CMUDict</h3><div>Actually, it seems like I could just use the dictionary directly. &nbsp;The whole problem is one of how to get the entries from this file into a subset file that holds just what I want - so I'll just write a small script to do just that. &nbsp;What a pain. &nbsp;</div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">wget http://svn.code.sf.net/p/cmusphinx/code/trunk/cmudict/sphinxdict/cmudict_SPHINX_40</span></span></pre>I'll post the script soon - it's being added to a larger package that should make the process of getting a personal language model pretty painless. &nbsp;That'd be nice. <br /><br /><br /><br />