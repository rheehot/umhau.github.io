---
layout: post
title: 'Setting Up an Offline Transcriber Using Kaldi - Part 1: kaldi-offline-transcriber'
date: '2016-07-26T17:57:00.001-04:00'
author: umhau
tags:
- kaldi
- speech to text
- DNN
- kaldi-offline-transcriber
- alumae
- offline-transcription
categories: experiments
modified_time: '2016-07-27T14:47:10.164-04:00'
blogger_id: tag:blogger.com,1999:blog-2584289275272726799.post-4166347225901726236
blogger_orig_url: http://nixingaround.blogspot.com/2016/07/setting-up-offline-transcriber-using.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">This is being recorded as I go. &nbsp;I'll be editing it and changing it to reflect the best way to set it up. &nbsp;My goal is to be able to record a snippet of my voice and have it transcribed by a python script I'll write.<br /><h2 style="text-align: left;">First Attempt: Kaldi-offline-transcriber</h2>The first shot at completing this project is this GitHub: <a href="http://github.com/alumae/kaldi-offline-transcriber" target="_blank">github.com/alumae/kaldi-offline-transcriber</a>. The only problem is that this transcriber, though excellent of itself, is built for the Estonian language. &nbsp;After I successfully get it working in Estonian, I'll see what I can do about English. <br /><br />I should note that the instructions in the <a href="https://github.com/alumae/kaldi-offline-transcriber" target="_blank">github readme</a> are excellent. &nbsp;I've rewritten them here so I have easy access to them, and to make them a little better -- just made them cut-and-paste worthy, mostly.<br /><h3 style="text-align: left;">Dependencies Installation</h3><div>Not sure if this comes with Ubuntu 16.04 or if I'd already installed this for something else, but make sure this is installed. &nbsp;</div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;"><span style="background-color: transparent;">sudo apt-get install build-essential</span></pre><div>Also install these:</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;"><span style="background-color: transparent;">sudo apt-get install ffmpeg sox </span><span style="background-color: transparent;">libatlas-dev </span></pre></div><div><a href="{{ site.baseurl }}{% post_url 2016-07-26-installing-kaldi-and-kaldi-gstreamer %}" target="_blank">Install Kaldi.</a> &nbsp;Don't have to worry about the online extensions, but it won't hurt to have them installed (an extra file compiled in a directory is the only difference).</div><div><br /></div><div>Make sure Python and pip are installed.</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;"><span style="background-color: transparent;">sudo apt-get install python-pip</span></pre></div><div>Install the package pyfst. &nbsp;One of its dependencies, OpenFst, was compiled and installed with Kaldi. &nbsp;To exploit that installation, use these install flags when you install pyfst:</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">CPPFLAGS="-I/home/$USER/tools/kaldi-master/tools/openfst/include -L/home/$USER/tools/kaldi-master/tools/openfst/lib" pip install pyfst</pre></div><div><div style="text-align: left;">Turns out you also need Java installed, which isn't mentioned in the readme file. &nbsp;</div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">sudo apt-get install default-jre</pre><h3 style="text-align: left;">Installing the Main Package</h3></div><div>Clone the repository.</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">cd ~/tools<br />git clone https://github.com/alumae/kaldi-offline-transcriber.git</pre></div><div>This is Estonian, remember? &nbsp;Download and unpack the Estonian language models.</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">cd ~/tools/kaldi-offline-transcriber<br />curl http://bark.phon.ioc.ee/tanel/kaldi-offline-transcriber-data-2015-12-29.tgz | tar xvz </pre></div><div>Create a file in the root of the transcriber directory called makefile.options. &nbsp;Inside, set the KALDI_ROOT option as the root of the kaldi directory. &nbsp;Use [enter] and [CTRL-D] to complete the command.</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">cat &gt; ~/tools/kaldi-offline-transcriber/Makefile.options [enter]<br />KALDI_ROOT=/home/$USER/tools/kaldi-master [CTRL-D]</pre></div><div>Without this the compiler will throw an error wondering where the files it's trying to compile are located. &nbsp;Next, compile. &nbsp;This should take about 30 minutes, so use the option for multiple cores if possible.</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">cd ~/tools/kaldi-offline-transcriber/<br />make -j 4 .init</pre></div><div>All compilations are stored under the kaldi-offline-transcriber/build/ directory. &nbsp;If you want to retry the compilation, just delete that directory and try again.</div><h3 style="text-align: left;">Example Usage</h3><h4 style="text-align: left;">Using the make command directly</h4><div>Stick a speech file under src-audio, then execute the command to create the transcription file. &nbsp;</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">cd src-audio<br />wget http://media.kuku.ee/intervjuu/intervjuu201306211256.mp3<br />cd ..<br />make build/output/intervjuu201306211256.txt</pre></div><div>To remove the intermediate files that are generated with the build command, run:</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">make .intervjuu201306211256.clean</pre></div><h4 style="text-align: left;">Using the speech2text.sh script</h4><div>There was a wrapper created to more easily transcribe audio files located in any directory. &nbsp;This is accessed with the following example command:</div><div><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">/home/$USER/tools/kaldi-offline-transcriber/speech2text.sh --trs result/test.txt audio/test.ogg</pre></div><h3 style="text-align: left;">Tweaks</h3><div>You can speed up transcription by setting another parameter in makefile.options. <br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; max-height: 600px; overflow: auto; padding: 5px; width: auto; word-wrap: normal;">nano ~/tools/kaldi-offline-transcriber/Makefile.options<br />nthreads = 4</pre><br /></div><div><br /></div><div><br /></div></div>