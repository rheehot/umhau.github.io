<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">


    <link rel="stylesheet" type="text/css" href="/assets/css/styles.css">
    <meta name="viewport" content="width=device-width">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/js/infinite-jekyll.js"></script>

  </head>
  <body>
    <box class="wrapper">
      <header>
        <a href=""> <h1>*nixing around</h1> </a>
        <p>A programmer's journal of complicated projects.</p>
        <p class="view"><a href="">github</a> | <a href="/about">about</a> | <a href="/explore">explore</a></p>

        <p>testing</p>

      </header>
      <section>

      <div class="post">

    <header class="post-header">
        
    <h1 class="post-title">Raspberry Pi Zero USB Audio on Raspbian Jessie (method 1)</h1>
    <p 
        class="post-meta">Nov 22, 2016 • <a  href="/2016/11/22/raspberry-pi-zero-usb-audio/">permalink</a>
        <i>  • audio • Raspbian Jessie • USB • STATIC • success • ALSA • Raspberry Pi</i> 
    </p>
    </header>

    <article class="post-content">
    I'm surprised how much of a pain it is to get a USB audio controller set up without a GUI. &nbsp;I'm trying to use the RPi Zero, which doesn't have any audio hardware - not even a pin-based PWN situation. &nbsp;Anything has to be done with extra hardware - either USB or custom analog with an ADC (analog-digital converter).<br /><br />Note that extra static on the line seems to be related to the bitrate and frequency of the recording. If one has a lot of static, try another. The static on playback and when nothing is playing seems to be from the line - it's on a USB hub that also runs the powerful TP-Link wifi adapter. &nbsp;Since USB is already directly connected to the RPi's GND, there isn't really anything else that can be done about the static. &nbsp;Hence, custom hardware as the alternative.<br /><br />There is more than one way to skin a cat; this is the first method, which I think I prefer. &nbsp;The other method is <a href="https://nixingaround.blogspot.com/2016/11/raspberry-pi-zero-usb-audio-on-raspbian.html" target="_blank">here</a>.<br /><br />Overall, setting up audio on Linux and Raspbian is an overly complex process that is definitely not user-friendly. &nbsp;I'm a user, and this was <i>not</i>&nbsp;a positive experience to sort out.<br /><h4>ID your sound card devices</h4>Figure out what the card, device and subdevice numbers are. &nbsp;This command makes it pretty straightforward.<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;">cat /proc/asound/modules</pre><h4>Change default sound card to USB audio</h4>ALSA configuration file has moved (<a href="http://superuser.com/questions/989385/alsa-base-conf-missing-in-new-raspberry-pi-raspbian-jesse" target="_blank">source</a>) - edit to reflect a new default device setting. &nbsp;You want the default sound card to be the same number as your USB card (as found above). &nbsp;Open the following file:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;">sudo nano /usr/share/alsa/alsa.conf</pre>Look for the following two lines, and change the trailing 0's to match the number of your USB sound card.<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">defaults.ctl.card 1 # was 0<br />defaults.pcm.card 1 # was 0</span></span></pre><b>Note:</b>&nbsp;This is the same file previously located at<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;">/etc/modprobe.d/alsa-base.conf</pre>For some reason it was moved, and it's unfortunate that many of the tutorials dealing with USB audio are old enough to still refer to the old file location. <br /><h4>Allow USB audio to be set as default</h4>Close that file. &nbsp;There is another file which overrides the /etc/modprobe.d/ files and sets all USB cards with a negative (never default) index. (<a href="http://superuser.com/a/1018679" target="_blank">source</a>&nbsp;- not sure about the overwriting thing, though, as the /etc/-based file doesn't exist.) Open it and comment out the relevant line.<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">sudo nano /lib/modprobe.d/aliases.conf</span></span></pre>Comment out (put a # in front of) this line:<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">options snd-usb-audio index=-2</span></span></pre>The file does say it doesn't need to be modified, but that's to prevent "unusual" cards from being set as default - which is exactly what we want.<br /><h4>Set USB as the default audio device</h4>Open the user-specific alsa config file, back it up, and replace the contents. &nbsp;(<a href="http://superuser.com/a/1018679" target="_blank">source</a> and <a href="https://www.raspberrypi.org/forums/viewtopic.php?f=28&amp;t=124016&amp;p=857433&amp;hilit=usb+audio#p857433" target="_blank">source</a>)<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;">cp ~/.asoundrc ~/.asoundrc.bak<br />sudo nano ~/.asoundrc</pre>Replace everything in the file with the following. (<b>alternative: </b>use the existing format, and change the 0's to 1's)<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;"><strike>pcm.!default plughw:Device<br />ctl.!default plughw:Device</strike><br /><br />pcm.!default {<br />    type hw<br />    card 1<br />}<br /><br />ctl.!default {<br />    type hw<br />    card 1<br />}</span></span></pre>The backup is located at ~/.asoundrc.bak. &nbsp;If you're curious about that weird plughw string, run<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;">aplay -L</pre>to see a few examples of it. (this is a more complete version of the aplay -l command used above)<br /><h4>Test the results</h4><div>A command to run a built-in sound file that tests the left and right channels. Disclaimer: it doesn't work for me. &nbsp;I had to create a very custom file with specific formats in order to get a result. &nbsp;(TODO later)</div><div><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;">aplay /usr/share/sounds/alsa/Front_Center.wav</pre></div><h3>What didn't work</h3><div>Tracking failures, for later.</div><h4>Changing hardware defaults in aliases.conf</h4>(<a href="http://raspberrypi.stackexchange.com/a/21989" target="_blank">source</a>) Open and edit:<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">sudo nano /lib/modprobe.d/aliases.conf</span></span></pre>Change and edit these lines. &nbsp;One exists already, the second should be added directly below it.<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">options snd-usb-audio index=0<br />options snd_bcm2835 index=1</span></span></pre>That way, all the problems are short-circuited from the beginning.<br /><br /><b>What happened:</b>&nbsp;made the change, rebooted and ran aplay -l to see what was up: the USB device wasn't even listed. &nbsp;Apparently, that lower-level adjustment was not pleasing to the ALSA gods. &nbsp;A better magic is required.<br /><h3>Sources</h3><div>I'm going to leave these here once I'm done as a permanent record in case anything goes wrong in the future. &nbsp;They're good sources.</div><ul><li><a href="http://raspberrypi.stackexchange.com/questions/39928/unable-to-set-default-input-and-output-audio-device-on-raspberry-jessie">http://raspberrypi.stackexchange.com/questions/39928/unable-to-set-default-input-and-output-audio-device-on-raspberry-jessie</a></li><li><a href="http://raspberrypi.stackexchange.com/questions/19705/usb-card-as-my-default-audio-device">http://raspberrypi.stackexchange.com/questions/19705/usb-card-as-my-default-audio-device</a></li><li><a href="http://raspberrypi.stackexchange.com/questions/36097/how-to-force-rpi-to-use-usb-soundcard">http://raspberrypi.stackexchange.com/questions/36097/how-to-force-rpi-to-use-usb-soundcard</a></li><li><a href="https://www.raspberrypi.org/forums/viewtopic.php?t=20866">https://www.raspberrypi.org/forums/viewtopic.php?t=20866</a></li></ul><h3>Extra Stuff</h3><h4>Other ways to check what audio devices are available</h4><div>You can also use this to see what USB devices are connected:<br /><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;">lsusb</pre></div><div>After running the following command, look for the entry that refers to your USB audio device.</div><div><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;">aplay -l</pre>In my case, the entry showed card 1, device 0, and only one subdevice, numbered 0 as the USB audio device I wanted. &nbsp;See below for my output. &nbsp;(This is a RPi Zero with a USB audio device connected)<br /><pre style="background-color: #eff0f1; border: 0px; margin-bottom: 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;"><span style="color: #333333;"><span style="font-size: 14px;">**** List of PLAYBACK Hardware Devices ****<br />card 0: ALSA [bcm2835 ALSA], device 0: bcm2835 ALSA [bcm2835 ALSA]<br />  Subdevices: 8/8<br />  Subdevice #0: subdevice #0<br />  Subdevice #1: subdevice #1<br />  Subdevice #2: subdevice #2<br />  Subdevice #3: subdevice #3<br />  Subdevice #4: subdevice #4<br />  Subdevice #5: subdevice #5<br />  Subdevice #6: subdevice #6<br />  Subdevice #7: subdevice #7<br />card 0: ALSA [bcm2835 ALSA], device 1: bcm2835 ALSA [bcm2835 IEC958/HDMI]<br />  Subdevices: 1/1<br />  Subdevice #0: subdevice #0<br />card 1: EarMicrophone [USB Ear-Microphone], device 0: USB Audio [USB Audio]<br />  Subdevices: 1/1<br />  Subdevice #0: subdevice #0</span></span></pre></div><div><div>And this one gives a more complete version than the lowercase option.</div><br /><div></div><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><pre style="background-color: #eff0f1; border: 0px; color: #333333; font-size: 14px; margin: 0px 0px 1em; overflow: auto; padding: 5px; text-align: justify; width: auto; word-wrap: normal;">aplay -L</pre></div></div><br />
    </article>

    <p class="extra-space"></p>
    <hr>
    <p class="extra-space"></p>

</div>





      </section>
      <footer>
        <p><small>Hosted on GitHub &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a> and <a href="https://github.com/umhau">umhau</a></small></p>
      </footer>
    </box>
    <script src="/assets/js/scale.fix.js"></script>


  



  </body>
</html>
